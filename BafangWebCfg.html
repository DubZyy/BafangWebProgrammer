<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bafang Web Config</title>
  <style>
    body {
      font-family: sans-serif;
      margin-bottom: 10em;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      font-size: 11pt;
    }
    table {
      border: 0; /*1px solid gray;*/
      border-collapse: collapse;
      width: 100%;
    }
    td, th {
      border: 0;
      border-top: 1px solid gray;
      padding: 5px;
      border: 1px solid gray;
    }
    th {
      text-align: left;
    }
    td {
      min-width: 10ex;
      text-align: left;
      background: #eee;
      font-family: monospace;
    }
    div.block {
      margin-top: 1em;
    }
    h1 {
      border-bottom: 2px solid black;
    }
    h2 {
      /*border-bottom: 1px solid black;*/
      background: #777;
      color: white;
      padding: 8px;
      border-radius: 3px;
    }
    button {
      /*margin-bottom: 1em;*/
    }

    input.cfg {
      border: 0;
      font: inherit;
      background: transparent;
      font-family: monospace;
      width: 99%;
      padding-left: 4px;
    }
    a {
      text-decoration: none;
    }
    div.creds {
      margin-top: 2em;
      text-align: right;
      font-size: 80%;
      color: #555;
    }
    .error-display {
      min-height: 1em;
      padding: 5px;
      background: #eee;
      text-align: center;
      margin-bottom: 1em;
      margin-top: 1em;
      border-radius: 3px;
    }
    .highlight-error {
      background: yellow;
    }
    #file-pick {
      margin-bottom: 1em;
      /*width: 100%;*/
      /*background: #eee;*/
    }
    button {
      /*min-width: 20%;*/
    }
    select.cfg {
      width: 100%;
      font-size: 100%;
      font-family: monospace;
      background: transparent;
      border: 0;
    }
    div#saveload {
      /*border-top: 2px solid black;*/
      padding: 15px;
      border: 1px solid #aaa;
      margin-top: 15px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>Bafang BBSxx Configuration</h1>
  <div>
    <button id="connect-to-serial">Open serial port</button>
  </div>
  <div id="saveload">
  <div>
    <label>Load File:
    <input type="file" id="file-pick" accept=".json,.el"/>
  </label>
  </div>
    <div>
    <label>Save File:
      <button id="save-file" type="button" disabled=1>Download</button>
    </label>
  </div>
  </div>
  <div class="block">
    <h2>Info</h2>
    <button id="read-gen" type="button" disabled=1>Connect controller</button>
    <button id="read-all" type="button" disabled=1>Read All</button>
    <div class="error-display" id="info"></div>
    <table id="info">
    <tbody>
    <tr><th>Manufacturer</th> <td id="manufacturer"></td></tr>
    <tr><th>Model</th><td id="model"></td></tr>
    <tr><th>HW Version</th><td id="hw_ver"></td></tr>
    <tr><th>FW Version</th><td id="fw_ver"></td></tr>
    <tr><th>Voltage</th><td id="voltage"></td></tr>
    <tr><th>Max Current (A)</th><td id="max_current"></td></tr>
    </tbody>
    </table>
  </div>

  <div class="block">
    <h2>Basic</h2>
    <button id="read-bas" type="button" disabled=1>Read</button>
    <button id="write-bas" type="button" disabled=1>Write</button>
    <div class="error-display" id="basic"></div>
    <table id="basic">
    <tbody>
      <!--<tr><th colspan="2">Low Battery Protect (V)</th><td contenteditable='true' id="low_battery_protect" class="cfg"></td></tr>-->
      <tr><th colspan="2">Low Battery Protect (V)</th><td><input type="number" id="low_battery_protect" class="cfg" min=18 max=70/></td></tr>
      <tr><th colspan="2">Current Limit (A)</th> <td> <input type="number" id="current_limit" class="cfg" min=1 max=30 /></td></tr>
      <tr><th colspan="2">Wheel Diameter</th> <td><select id="wheel_size" class="cfg">
        <option>16"</option>
        <option>17"</option>
        <option>18"</option>
        <option>19"</option>
        <option>20"</option>
        <option>21"</option>
        <option>22"</option>
        <option>23"</option>
        <option>24"</option>
        <option>25"</option>
        <option>26"</option>
        <option>27"</option>
        <option>28"</option>
        <option>29"</option>
        <option>30"</option>
        <option>700C</option>
      </select></td></tr>
      <tr><th colspan="2">Speedmeter Model</th> <td><select id="speedmeter_model" class="cfg">
      <option>External</option>
      <option>Internal</option>
      <option>Motorphase</option>
    </select></td></tr>

      <tr><th colspan="2">Speedmeter Signals</th> <td><input type="number" id="speedmeter_signals" class="cfg" min=0 max=63/></td></tr>
      <tr><th colspan="3" style="border:0;"></th></tr>
      <tr><th>Assist</th><th>Current (%)</th><th>Speed (%)</th></tr>
      </tbody>
    </table>
  </div>

  <div class="block">
    <h2>Pedal Assist</h2>
    <button id="read-pas" type="button" disabled=1>Read</button>
    <button id="write-pas" type="button" disabled=1>Write</button>
    <div class="error-display" id="pedal"></div>
    <table id="pedal">
    <tbody>
      <tr><th>Pedal Type</th> <td><select id="pedal_type" class="cfg">
        <option>None</option>
        <option>DH-Sensor-12</option>
        <option>BB-Sensor-32</option>
        <option>DoubleSignal-24</option>
      </select></td></tr>
      <tr><th>Designated Assist (0-9)</th> <td><select id="designated_assist" class="cfg"/></td></tr>
      <tr><th>Speed Limit (km/h)</th> <td><input list="by-display" id="speed_limit" class="cfg"/></td></tr>
      <tr><th>Start Current (%)</th> <td><input type="number" min=0 max=100 id="start_current" class="cfg"/></td></tr>
      <tr><th>Slow-Start Mode (1-8)</th> <td><select id="slow_start_mode" class="cfg"/></td></tr>
      <tr><th>Startup Degree (Signal No.)</th> <td><input type="number" id="startup_degree" class="cfg"/></td></tr>
      <tr><th>Work Mode (pedal/wheel*10)</th> <td><input list="work-modes" id="work_mode" class="cfg"/></td></tr>
      <datalist id="work-modes">
        <option value="Undetermined" />
      </datalist>
      <tr><th>Time of Stop (x 10 ms)</th> <td><input type="number" id="time_of_stop" class="cfg"/></td></tr>
      <tr><th>Current Decay (1-8)</th> <td><select id="current_decay" class="cfg"/></td></tr>
      <tr><th>Stop Decay (x 10 ms)</th> <td><input type="number" id="stop_decay" class="cfg"/></td></tr>
      <tr><th>Keep Current (%)</th> <td><input type="number" min=1 max=100 id="keep_current" class="cfg"/></td></tr>
      </tbody>
    </table>
  </div>
  <datalist id="by-display">
    <option value="Display"/>
  </datalist>
  
  <div class="block">
    <h2>Throttle</h2>
    <button id="read-thr" type="button" disabled=1>Read</button>
    <button id="write-thr" type="button" disabled=1>Write</button>
    <div class="error-display" id="throttle"></div>
    <table id="throttle">
    <tbody>
      <tr><th>Start Voltage (x 100 mV)</th> <td><input type="number" id="start_voltage" class="cfg"/></td></tr>
      <tr><th>End Voltage (x 100 mV)</th> <td><input type="number" id="end_voltage" class="cfg"/></td></tr>
      <tr><th>Mode</th> <td><select id="mode" class="cfg">
        <option>Speed</option>
        <option>Current</option>
      </select></td></tr>
      <tr><th>Designated Assist (0-9)</th> <td><select id="designated_assist" class="cfg"/></td></tr>
      <tr><th>Speed Limit (km/h)</th> <td><input list="by-display" id="speed_limit" class="cfg"/></td></tr>
      <tr><th>Start Current (%)</th> <td><input type="number" min=0 max=100 id="start_current" class="cfg"></td></tr>
      </tbody>
    </table>
  </div>
  
  <pre id="serial-messages-container"></pre>

  <div class="creds">By Jonatan Liljedahl - <a href="http://kymatica.com">www.kymatica.com</a></div>

  <script src="./app.js"></script>
  <script>
    /***********************************
    Bafang Web Config

    Copyright (c) 2021 Jonatan Liljedahl
    ************************************/

    const bafang = new BafangConfig();
    const connectButton = document.getElementById('connect-to-serial');
    const serialMessagesContainer = document.getElementById('serial-messages-container');
    const readAllButton = document.getElementById('read-all');
    const readGenButton = document.getElementById('read-gen');
    const readBasButton = document.getElementById('read-bas');
    const readPasButton = document.getElementById('read-pas');
    const readThrButton = document.getElementById('read-thr');
    const writeBasButton = document.getElementById('write-bas');
    const writePasButton = document.getElementById('write-pas');
    const writeThrButton = document.getElementById('write-thr');
    const filePicker = document.getElementById('file-pick');
    const saveFileButton = document.getElementById('save-file');

    window.onload = () => {
      const t = document.querySelector("table#basic");
      
      for(let i=0;i<10;i++) {
        let row = t.insertRow();
        let th = document.createElement("th");
        th.innerText = i;
        row.appendChild(th);
        let cell1 = row.insertCell();
        let num1 = document.createElement("input");
        cell1.appendChild(num1);
        let cell2 = row.insertCell();
        let num2 = document.createElement("input");
        cell2.appendChild(num2);
        num1.id = "assist"+i+"_current";
        num2.id = "assist"+i+"_speed";
        for (let e of [num1,num2]) {
          e.setAttribute("type","number");
          e.setAttribute("min",0);
          e.setAttribute("max",100);
          e.classList.add("cfg");
        }
      }

      const a = document.querySelectorAll("select#designated_assist");
      for (let sel of a) {
        for(let i=0;i<10;i++) {
          let opt = document.createElement("option");
          opt.innerText = "Assist "+i;
          opt.value = i;
          sel.appendChild(opt);
        }
        let opt = document.createElement("option");
        opt.innerText = "Display";
        // opt.innerText = "Set by display";
        // opt.value = "Display";
        sel.appendChild(opt);
      }

      //slow_start_mode current_decay
      for (let id of ["slow_start_mode","current_decay"]) {
          const sel = document.querySelector("select#"+id);
          for(let i=1;i<9;i++) {
            let opt = document.createElement("option");
            opt.innerText = i;
            sel.appendChild(opt);
          }
      }

      if (window.File && window.FileReader) {
        // Great success! All the File APIs are supported.
      } else {
        alert('The File APIs are not fully supported in this browser.');
      }

    };

    bafang.parseTable = (name) => {
      console.log("Parsing table",name);
      let info = {};
      bafang.data[name] = info;
      const nodes = document.querySelectorAll("table#"+name+" .cfg");
      for (e of nodes) {
        const val = e.tagName == "TD" ? e.innerText : e.value;
        const num = parseInt(val);
        info[e.id] = num==val ? num : val;
      }
    };

    function updateTable(name, info) {
      console.log("Updating table",name);
      if(!info) info = bafang.data[name];
      const infoTable = document.querySelector("table#"+name);
      for (key in info) {
          const e = infoTable.querySelector("#"+key);
          if(e) {
            if(e.tagName == "TD")
              e.innerText = info[key];
            else
              e.value = info[key];
          }
      }
    }

    function clearErrorHL() {
      let a = document.querySelectorAll(".highlight-error");
      for (e of a)
        e.classList.remove("highlight-error");
    }

    bafang.onWrite = (blk, key) => {
      clearErrorHL();
      if(!!key) {
        // window.scrollTo({top:0, behaviour: 'smooth'});
        blk = blockKeys[blk];
        console.log("Error at",blk,key);
        let e = document.querySelector("table#"+blk+" #"+key);
        e.classList.add("highlight-error");
      }
    };

    bafang.onRead = (blk) => {
      clearErrorHL();
      switch(blk) {
        case BLK_GEN: // Connected to controller
          for (b of [readAllButton, readBasButton, readPasButton, readThrButton]) {
            b.removeAttribute('disabled');
          }
          saveFileButton.removeAttribute('disabled');
        break;
        case BLK_BAS:
          writeBasButton.removeAttribute('disabled');
        break;
        case BLK_PAS:
          writePasButton.removeAttribute('disabled');
        break;
        case BLK_THR:
          writeThrButton.removeAttribute('disabled');
        break;
      }

      if(blk) {
        updateTable(blockKeys[blk]);
      } else { // read file
          if(!readBasButton.disabled) // only if we connected to controller
            for (b of [writeBasButton, writePasButton, writeThrButton]) {
              b.removeAttribute('disabled');
            }
          saveFileButton.removeAttribute('disabled');
          for (let k in bafang.data) {
            updateTable(k);
          }
      }
//      serialMessagesContainer.innerText = JSON.stringify(bafang.data,null,2);
    };
    
    bafang.onSerialConnect = (port) => {
      readGenButton.removeAttribute('disabled');
      //console.log(port); // TODO: would be nice if we could get the port name here!
    };
    
    connectButton.addEventListener('click', () => {
      bafang.init();
    });

    readGenButton.addEventListener('click', () => {
      bafang.connectDevice();
    });

    readAllButton.addEventListener('click', () => {
      bafang.readAllBlocks();
    });
    readBasButton.addEventListener('click', () => {
      bafang.readBlock(BLK_BAS);
    });
    readPasButton.addEventListener('click', () => {
      bafang.readBlock(BLK_PAS);
    });
    readThrButton.addEventListener('click', () => {
      bafang.readBlock(BLK_THR);
    });
    
    writeBasButton.addEventListener('click', () => {
      bafang.writeBlock(BLK_BAS);
    });
    writePasButton.addEventListener('click', () => {
      bafang.writeBlock(BLK_PAS);
    });
    writeThrButton.addEventListener('click', () => {
      bafang.writeBlock(BLK_THR);
    });

    filePicker.addEventListener('change', (evt) => {
      bafang.readFile(evt.target.files[0]);
    });

    saveFileButton.addEventListener('click', () => {
      bafang.saveFile();
    });

    navigator.serial.addEventListener("connect", (event) => {
      // TODO: Automatically open event.target or warn user a port is available.
      console.log("Connected "+event.target);
    });

    navigator.serial.addEventListener("disconnect", (event) => {
      // TODO: Remove |event.target| from the UI.
      // If the serial port was opened, a stream error would be observed as well.
      console.log("Disconnected "+event.target);
    });

  </script>

</body></html>
